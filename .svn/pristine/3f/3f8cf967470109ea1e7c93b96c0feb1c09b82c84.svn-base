$(document).ready(function(){
	$('#btn_logout').click(function(){
		switchHtml("/TanTimaServices/html/login/login.html");	
	});
	
	renderQueryPatient();
});

//查詢病人清單  參數  
//var patientList2 = new getChartPtNameBirthTelObj(empNo,sessionID,chartNo,ptName,birthDate,tel,"getChartByChartNoPtNameBirthDateTel"); 
var getChartPtNameBirthTelObj = function(empNo,sessionID,chartNo,ptName,birthDate,tel,method){
	this.empNo = empNo;
	this.sessionID = sessionID;
	this.chartNo = chartNo;
	this.ptName = ptName;
	this.birthDate = birthDate;
	this.tel = tel;
	this.method = method;
}

var QueryObj = { // 查詢物件
		chkopd : true,
		chkinp : true,
		chkdis : false,
		opddays : 0,
		disdays : 0,
		ptName : null,
		birth : null,
		tel : null,
		chartNo : null
	}




function renderQueryPatient(){
	
	
	$(document).on('click', '#btn_query1', function(event) {
		changeQueryTable();
	});

	$(document).on('click', '#btn_query2', function(event) {
		changeQueryTable("chart_base");
	});
	
	//搜尋姓名
	$(document).on('change', '#query_ptName', function(event) {
		if ($(this).val().length == 0 || char_regex.test($(this).val())) {
//			stateChange(true, '#query_ptName');
			if ($(this).val().length > 0){
				QueryObj.ptName = $(this).val();
				changeQueryTable("chart_base");
			}else{
				QueryObj.ptName = null;
			}
				
		} else {
//			stateChange(false, '#query_ptName', "請輸入字元");
		}
	});
	
	//搜尋出生日期
	$(document).on('change', '#query_birth', function(event) {
		if ($(this).val().length == 0 || ROCdata_regex.test($(this).val())) {
//			stateChange(true, '#query_birth');
			if ($(this).val().length > 0){
				QueryObj.birth = $(this).val();
				changeQueryTable("chart_base");
			}else{
				QueryObj.birth = null;
			}
				
		} else {
//			stateChange(false, '#query_birth', "請輸入正確的日期格式 範例:'1070101' ");
		}
	});

    //搜尋電話	
	$(document).on('change', '#query_tel', function(event) {
		if ($(this).val().length == 0 || number_regex.test($(this).val())) {
//			stateChange(true, '#query_tel');
			if ($(this).val().length > 0){
				QueryObj.tel = $(this).val();
				changeQueryTable("chart_base");
			}else{
				QueryObj.tel = null;
			}
				
		} else {
//			stateChange(false, '#query_tel', "請輸入數字");
		}
	});
	
	//搜尋病歷號
	$(document).on('change', '#query_chartNo', function(event) {
		if ($(this).val().length == 0 || number_regex.test($(this).val())) {
//			stateChange(true, '#query_chartNo');
			if ($(this).val().length > 0){
				QueryObj.chartNo = $(this).val();
				changeQueryTable("chart_base");
			}else{
				QueryObj.chartNo = null;
			}
				
		} else {
//			stateChange(false, '#query_chartNo', "請輸入數字");
		}
	})
	
}


var changeQueryTable = function(type) {
	if (type == "chart_base") {
		if (QueryObj.ptName == null && QueryObj.birth == null
				&& QueryObj.tel == null && QueryObj.chartNo == null) {
			alert("請至少輸入一項查詢資料");
		} else {
//			showLoading();
			ajax_getChartByChartNoPtNameBirthDateTel("ChartService",LoginObj.empNo,LoginObj.session_id,QueryObj.chartNo,QueryObj.ptName,QueryObj.birth,QueryObj.tel);
		}		
	} else {
		if ($('#chk_queryOPD').is(":checked")) {
			if ($('#input_OPDdays').val().length > 0
					&& number_regex.test($('#input_OPDdays').val())) {
				QueryObj.chkopd = true;
				QueryObj.opddays = $('#input_OPDdays').val();
//				stateChange(true, '#input_OPDdays');
			} else {
//				stateChange(false, '#input_OPDdays', "請輸入數字");
			}
		} else {
			QueryObj.chkopd = false;
		}

		if ($('#chk_queryINP').is(":checked")) {
			QueryObj.chkinp = true;
//			ajax_getPatientListDischarge();
		} else {
			QueryObj.chkinp = false;
		}

		if ($('#chk_queryDIS').is(":checked")) {
			if ($('#input_DISdays').val().length > 0
					&& number_regex.test($('#input_DISdays').val())) {
				QueryObj.chkdis = true;
				QueryObj.disdays = $('#input_DISdays').val();
//				stateChange(true, '#input_DISdays');
			} else {
//				stateChange(false, '#input_DISdays', "請輸入數字");
			}
		} else {
			QueryObj.chkdis = false;
		}
//		mergeTable_PatList();
		
	}
}

var mergeTable_PatList = function() {
//	showLoading();
	$.when(ajax_getPatientListOpd(), ajax_getPatientListInp(),
			ajax_getPatientListDischarge()).done(
			function(dataOpd, dataInp, dataDis) {
				QueryPatArray =[];
				if (QueryObj.chkopd) {
					if (dataOpd[0].status == "Success") {
						$.each(dataOpd[0].resultSet, function(index, obj) {
							QueryPatArray.push(obj);
						});
					} else {
						ajaxErrMsg = dataOpd[0].errorMessage;
					}
				}
				if (QueryObj.chkinp) {
					if (dataInp[0].status == "Success") {
						$.each(dataInp[0].resultSet, function(index, obj) {
							QueryPatArray.push(obj);
						});
					} else {
						ajaxErrMsg = dataInp[0].errorMessage;
					}
				}
				if (QueryObj.chkdis) {
					if (dataDis[0].status == "Success") {
						$.each(dataDis[0].resultSet, function(index, obj) {
							QueryPatArray.push(obj);
						});
					} else {
						ajaxErrMsg = dataDis[0].errorMessage;
					}
				}
				jqGrid_PatList();								
//				hideLoading();
				
			});
}

function jqGrid_PatList(){	//門診住院出院
	$("#PatList").jqGrid({
	    datatype: "local",
	    height: 600,
	    colModel: [
	        { label: '病歷號', name: 'chart_no', width: 90, key:true,align:'right' },
	        { label: '就診類別', name: 'visit_type', width: 90,align:'center' },
	        { label: '姓名', name: 'pt_name', width: 100,align:'left' },
	        { label: '性別', name: 'sex_name', width: 60,align:'center' },
	        { label: '年齡', name: 'age', width: 60,align:'right' },
	        { label: '身分證字號', name: 'id_no', width: 130 },
	        { label: '電話', name: 'tel', width: 120,align:'right' },
	        { label: '門診日期', name: 'view_date', width: 90 },
	        { label: '出生日期', name: 'birth_date', width: 90 },
	        { label: '住院日期', name: 'ckin_date', width: 90 },
	        { label: '出院日期', name: 'discharge_date', width: 90 },
	        { label: '主治醫師', name: 'doctor_name', width: 90,align:'center' },
	        { label: '科別', name: 'div_name', width: 120,align:'center' },
	        { label: '早/午/晚', name: 'apn_name', width: 90,align:'center' },
	        { label: '診間', name: 'clinic', width: 90,align:'right' },
	        { label: '床位', name: 'bed_no', width: 90 },
	        { label: '護理站', name: 'ns', width: 90 }
	    ],
	    viewrecords: true, // show the current page, data rang and total records on the toolbar
	    //caption: "門診、住院、出院",
	    scrollOffset: 0,
//	    rowNum: Math.floor((pageHeight - 320)/26),
	    //rowList: [10, 20, 30],
	    onSelectRow:getSelectedRow,
	    ondblClickRow: function(rowId) {
	    	PatObj.chart_no = rowId;
//	    	showLoading();
	    	ajax_getChartByChartNo();
	    	popUpPageToggle("queryPage");	  
	    	closeOtherPage();
        },        
	    width: null,
	    shrinkToFit: false,
	    sortable: true,
		pager: "#PatList_Pager"
	});
	$("#PatList").jqGrid('filterToolbar', { stringResult: true, searchOnEnter: false, defaultSearch: "cn" ,clearSearch: false});
	$('#PatList').jqGrid('clearGridData');
	$("#PatList").jqGrid('setGridParam', {data: QueryPatArray});
	$("#PatList").trigger('reloadGrid');
	$('#currentList').show();
	$('#chartBaseList').hide();
	function getSelectedRow() {
	    var grid = $("#PatList");
	    var rowKey = grid.jqGrid('getGridParam',"selrow");
	    if (rowKey){        	    	
	    	$("#chart_no2").html($('#PatList').jqGrid('getCell',rowKey,'chart_no'));
	    	$("#pt_name2").html($('#PatList').jqGrid('getCell',rowKey,'pt_name'));
	    	$("#sex_name2").html($('#PatList').jqGrid('getCell',rowKey,'sex_name'));
	    	$("#age2").html($('#PatList').jqGrid('getCell',rowKey,'age'));
	    	$("#home_tel").html($('#PatList').jqGrid('getCell',rowKey,'tel'));
	    }
	    else{
	        alert("沒有資料被選擇");
	    }
	}
}

function jqGrid_PatList2(){		//病歷主檔
	$("#PatList2").jqGrid({
	    datatype: "local",
	    height: 600,
	    colModel: [
	        { label: '病歷號', name: 'chart_no', width: 90, key:true,align:'right' },
	        { label: '姓名', name: 'pt_name', width: 120 },
	        { label: '性別', name: 'sex_name', width: 60,align:'center' },
	        { label: '年齡', name: 'age', width: 60,align:'right' },
	        { label: '身分證字號', name: 'id_no', width: 130 },
	        { label: '出生日期', name: 'birth_date', width: 90 },
	        { label: '市話', name: 'home_tel', width: 120,align:'right' },
	        { label: '手機', name: 'mobile', width: 130,align:'right' },
	        { label: '地址', name: 'address', width: 570,align:'left' }
	    ],
	    viewrecords: true, // show the current page, data rang and total records on the toolbar
	    //caption: "病歷主檔",
	    onSelectRow:getSelectedRow,
	    ondblClickRow: function(rowId) {
	    	PatObj.chart_no = rowId;
//	    	showLoading();
	    	ajax_getChartByChartNo();
	    	popUpPageToggle("queryPage");
	    	closeOtherPage();
        },
	    width: null,
//	    rowNum: Math.floor((pageHeight - 320)/26),
	    shrinkToFit: false,
	    sortable: true,
		pager: "#PatList2_Pager",
		pagerpos:'left'
	});
	$('#PatList2').jqGrid('clearGridData');
	$("#PatList2").jqGrid('setGridParam', {data: QueryPatArray});
	$("#PatList2").trigger('reloadGrid');
	$("#PatList2").jqGrid('filterToolbar', { stringResult: true, searchOnEnter: false, defaultSearch: "cn" });
	$('#currentList').hide();
	$('#chartBaseList').show();
	function getSelectedRow() {
	    var grid = $("#PatList2");
	    var rowKey = grid.jqGrid('getGridParam',"selrow");
	    if (rowKey){        
	    	//$('#queryChartbasebody').html(rowKey + '-' +$('#PatList2').jqGrid('getCell',rowKey,'pt_name'));	    
	    	$("#chart_no2").html($('#PatList2').jqGrid('getCell',rowKey,'chart_no'));
	    	$("#pt_name2").html($('#PatList2').jqGrid('getCell',rowKey,'pt_name'));
	    	$("#sex_name2").html($('#PatList2').jqGrid('getCell',rowKey,'sex_name'));
	    	$("#age2").html($('#PatList2').jqGrid('getCell',rowKey,'age'));
	    	$("#home_tel").html($('#PatList2').jqGrid('getCell',rowKey,'home_tel'));
	    }
	    else{
	        alert("沒有資料被選擇");
	    }
	}
}


/**
 * 
 * ajax 病人清單2**/
var ajax_getChartByChartNoPtNameBirthDateTel = function(serviceName,empNo,sessionID,chartNo,ptName,birthDate,tel){
	
	var QueryPatArray = [];
//	LoginObj.empNo
//	LoginObj.session_id
	var patientList2 = new getChartPtNameBirthTelObj(empNo,sessionID,chartNo,ptName,birthDate,tel,"getChartByChartNoPtNameBirthDateTel"); 
	
	var request = $.when(ajax_Post(serviceName,JSON.stringify(patientList2))).done(function(data) {                                
		if (data.status == "Success") {
			
			$.each(data.resultSet, function(index, obj) {
				QueryPatArray.push(obj);
			});
			

		} else {
		  var ajaxErrMsg = data.errorMessage;
	     

		}
		
		jqGrid_PatList2();
		
    });

    request.onreadystatechange = null;
    request.abort = null;
    request = null;
};




